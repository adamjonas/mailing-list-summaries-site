<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>The email thread discusses a recently discovered exploit in LNbits, a Lightning Network application, that allows an attacker to create balances out of thin air by manipulating invoices. The exploit has been patched in LNbits version 0.10.5, and users are advised to update as soon as possible. The email suggests that similar exploits may be possible in other Lightning applications, particularly those used for custodial wallets, payment processors, and account management software.The attack involves the attacker inserting a payment hash from one payment into a different payment, creating a malicious invoice that tricks the backend into believing it is a legitimate payment. The process involves creating two invoices: A and B'. The attacker then deserializes B', replaces its payment hash with that of A, re-signs the invoice, and serializes it again, creating the malicious invoice B. The attacker then pays this invoice using a new account in LNbits.The LNbits backend checks the payment hash of incoming payments to determine if they are internal or via the Lightning Network. In this case, since the payment hash of A is used, the backend recognizes it as an internal payment. However, the critical issue is that payment hashes do not commit to payment details like the amount but only to the preimage. Therefore, the backend settles the payment internally by crediting A and debiting B, effectively creating a balance of 999 satoshis out of thin air.To mitigate this exploit, the email suggests using self-generated unique "checking ids" for looking up internal payments or implementing additional checks to ensure that the invoice details have not been tampered with, such as comparing the amounts of the original and received invoices.The email also highlights two lessons learned from this exploit. First, it emphasizes the level of sophistication of attackers familiar with Lightning Network technology. This attack requires a fundamental understanding of bolt-11 and custom tooling to produce the malicious invoice. Second, it points out that the "payment hash" of an invoice is actually a "preimage" hash and does not commit to payment details like the amount or pubkey. The email suggests using the term "preimage hash" instead to avoid developers assuming otherwise.Overall, the email serves as a warning to users and developers of Lightning Network applications about the potential exploit and provides recommendations for mitigating it.</p>
    <hr>
    <p><i> Updated on: 2023-07-05T02:56:41.477832+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>