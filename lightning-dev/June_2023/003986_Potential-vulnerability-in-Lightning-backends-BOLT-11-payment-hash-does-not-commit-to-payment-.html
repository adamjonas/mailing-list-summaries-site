<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>The email thread discusses a recently discovered exploit in LNbits, a Lightning Network application. The exploit allows an attacker to create balances by manipulating invoices. LNbits has released a patch for this vulnerability and urges users to update to version 0.10.5. The attack involves inserting the payment hash of one payment into a different payment, tricking the backend into believing that they are the same. This can result in the attacker creating "balances out of thin air. "To carry out the attack, the attacker creates two invoices: A and B'. Invoice A is created in LNbits with an amount of 1000 sat, while invoice B' is created on the attacker's own node with an amount of 1 sat. The attacker then modifies invoice B' by inserting the payment hash of invoice A into it. They re-sign the invoice, producing the malicious invoice B. The attacker then creates a new account in LNbits and pays invoice B. The backend uses the payment hash of invoice B to determine whether the payment is internal or via the Lightning Network. Since the payment hash matches invoice A, the backend settles the payment internally by crediting invoice A and debiting invoice B. As a result, the attacker effectively "creates" 999 sats.To mitigate this vulnerability, backends should use unique "checking ids" for looking up internal payments or implement additional checks to ensure that invoice details have not been tampered with (e.g., verifying that the amounts of both invoices match). It is important for developers to understand the sophistication of LN-savvy attackers and not assume that the payment hash commits to payment details like amount or pubkey.Overall, this exploit highlights the need for caution when handling invoices and emphasizes that the payment hash is merely a preimage hash and not a comprehensive representation of payment details.</p>
    <hr>
    <p><i> Updated on: 2023-07-11T02:42:46.307804+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>