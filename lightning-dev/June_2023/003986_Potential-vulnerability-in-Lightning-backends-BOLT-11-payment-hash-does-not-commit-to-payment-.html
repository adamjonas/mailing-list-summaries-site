<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>The email exchange discusses a recent exploit discovered by LNbits that allows an attacker to create balances by manipulating invoices. The specific vulnerability lies in LNBits backend, which does not properly verify the external received HTLC `amount_msat` against the invoice amount for both matching preimage and payment secret. This exploit has been patched in LNbits version 0.10.5, and users are encouraged to update immediately.It is suggested that custodial wallets, payment processors, and account management software based on LDK should not be affected if they adhere to the API recommendations of using `create_inbound_payment`. This is because the implementation handles the equivalence checks for amount internally. A link to the relevant code implementation is provided for reference.To mitigate potential attacks, it is recommended to implement "checking ids" to separate internal invoice state from external ones. However, caution should be taken to avoid issues with id collision if determined by the attacker.It is noted that previous safety issues with invoices have been known since CVE-2020-26896. Good disclosure security practice suggests informing Lightning implementation maintainers beforehand to facilitate patch coordination with second-line vendors like wallets and processors.In a separate email, callebtc from LNbits describes the details of the attack. The attacker was able to create a malicious invoice by inserting the payment hash of payment A into a different payment, tricking the backend into believing that the two payments are the same. This is possible because payment hashes only commit to the preimage, not the payment details like the amount.The attack involves creating invoice A of amount 1000 sat in LNbits, then creating invoice B' of amount 1 sat on the attacker's own node. The attacker deserializes B', replaces the payment hash with payment_hash(A), re-signs the invoice, and serializes it again as malicious invoice B. The attacker then creates a new account in LNbits and pays invoice B. The LNbits backend, using payment_hash(B), identifies the payment as internal and finds invoice A in its database. Since payment hashes do not commit to payment details like the amount, the backend settles the payment internally by crediting A and debiting B, effectively creating a balance of 999 sats.The suggested mitigation for this attack is for backends to use self-generated unique "checking ids" or additional checks to ensure that invoice details have not been tampered with. For example, asserting that the amounts of invoice A and B are equal. Two lessons are highlighted from this exploit. First, it emphasizes the sophistication of LN-savvy attackers who possess a deep understanding of bolt-11 and require custom tooling to carry out such attacks. Second, it points out the misconception regarding the "payment hash" of an invoice, which should be referred to as the "preimage" hash since it only commits to the preimage and not other payment details like the amount or pubkey. The email concludes by encouraging the adoption of this terminology change.</p>
    <hr>
    <p><i> Updated on: 2023-07-13T03:03:41.540308+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>