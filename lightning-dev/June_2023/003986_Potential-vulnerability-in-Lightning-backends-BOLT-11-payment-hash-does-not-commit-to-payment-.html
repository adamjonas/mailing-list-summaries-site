<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>LNbits, a Lightning Network application, has patched a vulnerability that allowed attackers to create fraudulent balances by exploiting how invoices are handled internally. The exploit involved inserting the payment hash of one payment into another, tricking the backend into believing they were the same. To carry out the attack, the attacker created two invoices: A with an amount of 1000 sat and B' with an amount of 1 sat. The attacker then serialized B', replaced its payment hash with that of A, and re-signed it, creating a malicious invoice B. When the attacker paid this invoice using a new account in LNbits, the backend settled the payment by crediting A and debiting B, effectively creating 999 sats out of thin air.The vulnerability stems from the fact that payment hashes in LNbits do not commit to payment details like the amount but only to the preimage. To mitigate this issue, backends should use unique "checking id's" for internal payments or perform additional checks to ensure the integrity of invoice details. This incident highlights the sophistication of LN-savvy attackers who possess a fundamental understanding of bolt-11 and have custom tools to produce malicious invoices.Furthermore, the incident raises awareness about the misconception surrounding the term "payment hash." It is actually a "preimage" hash and does not encompass payment details such as amount or pubkey. Developers are encouraged to refer to it as the "preimage hash" to avoid implicit assumptions about its functionality.It is recommended that users update to LNbits version 0.10.5 to protect against this vulnerability. The disclosure security practice suggests notifying Lightning implementation maintainers to coordinate patching efforts with second-line vendors like wallets and processors.</p>
    <hr>
    <p><i> Updated on: 2023-07-08T02:51:38.441414+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>