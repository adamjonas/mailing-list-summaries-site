<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>LNbits, a Lightning Network application, discovered an exploit that allows attackers to create balances by manipulating invoices. This exploit has been patched in LNbits version 0.10.5. However, the team believes that similar exploits may be possible in other Lightning applications. The attack involves inserting a payment hash from one payment into a different payment, tricking the backend into believing they are equal. To carry out the attack, the attacker creates two invoices: A and B'. In invoice B', the attacker replaces the payment hash with payment_hash(A), re-signs the invoice, and serializes it again, creating a malicious invoice B. The attacker then creates a new account in LNbits and pays invoice B. The LNbits backend uses the payment hash to determine if the payment is internal or via Lightning Network. Since payment_hash(A) commits to A, the backend finds A in its database and settles the payment internally by crediting A and debiting B. As a result, the attacker "creates" 999 satoshis.The suggested mitigation for this issue is for backends to use self-generated unique "checking ids" or additional checks to ensure that the invoice details have not been tampered with. It is important to note that payment hashes do not commit to payment details like the amount, but only to the preimage. Developers are encouraged to refer to the payment hash as the "preimage hash" to avoid any misconceptions about its function.This exploit highlights the level of sophistication of Lightning Network-savvy attackers and the need for developers to be aware of potential vulnerabilities. It is recommended to follow good disclosure security practices and communicate with Lightning implementation maintainers to coordinate patching efforts if necessary.</p>
    <hr>
    <p><i> Updated on: 2023-07-04T03:06:25.847354+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>