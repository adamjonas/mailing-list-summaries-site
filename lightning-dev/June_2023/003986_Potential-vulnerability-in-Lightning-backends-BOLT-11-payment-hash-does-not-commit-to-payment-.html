<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>According to the email, LNbits discovered a potential exploit that allows an attacker to create balances by manipulating invoices. The issue arises because LNBits backend does not verify if the received HTLC amount satisfies the invoice amount for both matching preimage and payment secret. The report suggests that custodial wallets, payment processors, and account management software based on LDK, which follow API recommendations, should not be affected as the amount equivalence checks are handled by the implementation. However, the report also mentions that there may be a possibility of issues with id collision in the "checking ids" mitigation method.The report highlights that safety issues with invoices have been known since CVE-2020-26896. It recommends that good disclosure security practice involves notifying Lightning implementation maintainers on their respective security communication channels to facilitate patch coordination with second-line vendors like wallets and processors.The email includes a detailed description of the attack. The attacker creates two invoices, A and B', with different amounts. Using a manipulation technique, the attacker inserts the payment hash of A into B' and re-signs it, creating a malicious invoice B. The attacker then creates a new account in LNbits and pays invoice B. The LNbits backend uses the payment hash of B to determine whether the payment is internal or via Lightning Network. Since the payment hash of A is found in the database, the backend settles the payment internally by crediting A and debiting B, allowing the attacker to "create" 999 satoshis.To mitigate this issue, the report suggests using self-generated unique "checking ids" for internal payment lookups or implementing additional checks to ensure that the invoice details have not been tampered with (e.g., verifying amount(A) == amount(B)).The report concludes with two lessons. First, it emphasizes the sophistication of LN-savvy attackers and their understanding of bolt-11. This attack requires a fundamental understanding of the protocol and custom tooling to create the malicious invoice. The second lesson is about the naming of the "payment hash" field in invoices. The report suggests referring to it as the "preimage hash" to avoid developers mistakenly assuming that it commits to payment details like amount or pubkey.Overall, the report raises awareness about a potential exploit in LNbits and provides recommendations for mitigating the issue. It also highlights the need for better understanding and terminology regarding payment hashes in Lightning Network applications.</p>
    <hr>
    <p><i> Updated on: 2023-07-06T03:05:40.768056+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>