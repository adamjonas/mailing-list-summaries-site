<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Antoine Riard 2023-06-19 20:34:10+00:00
            <br><i>Published on: 2023-06-19T20:34:10+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.xml.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003986.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>LNBits discovered an exploit last month that would allow attackers to create balances out of thin air by abusing a quirk in how invoices are handled internally. They have patched this in LNbits version 0.10.5 and urge anyone to update ASAP if they haven't already done so. The "payment hash" of an invoice is not a "payment" hash but merely a "preimage" hash â€“ and nothing else. The attacker was able to insert a bolt-11 payment hash of payment A into a different payment, creating a malicious invoice B that can trick the backend into believing that B == A. Potential safety issues with invoices have been known since CVE-2020-26896. The attack is possible because LNBits backend does not check that an external received HTLC `amount_msat` satisfies the invoice amount for both matching preimage and payment secret. If you're a custodial wallet, payment processor or account management software based on LDK, and you respect the API recommendations of using `create_inbound_payment`, you should not be affected as amount equivalence checks are handled by the implementation. The "checking ids" sounds a workable mitigation to firewall internal invoice state from external ones, though beware issues with id collision, if it can be determined by the attacker. Good disclosure security practice suggests having previously warned the Lightning implementation maintainers on their respective security communication channels to ease patch coordination if needed with second-line vendors like wallets and processors. The mitigation is quite simple. Backends should either use self-generated unique "checking id's" for looking up internal payments or use additional checks to make sure that the invoice details have not been messed around with (e.g., asserting amount(A) == amount(B)).</p>
    <hr>
    <p><i> Updated on: 2023-06-27T04:43:31.618885+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>