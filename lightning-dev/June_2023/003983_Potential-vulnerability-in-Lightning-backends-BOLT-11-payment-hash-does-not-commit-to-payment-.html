<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Dear list,Last month, the LNbits team discovered an exploit that allowed attackers to create fake balances by manipulating invoices. This exploit has been patched in LNbits version 0.10.5, and users are urged to update their systems as soon as possible. The team believes that similar exploits may be possible in other Lightning applications, especially those related to custodial wallets, payment processors, and account management software.The attack works by inserting a payment hash from one payment into another, tricking the backend into believing that the two payments are the same. Here is a step-by-step breakdown of the attack:1. The attacker creates invoice A with an amount of 1000 sat in LNbits.2. The attacker also creates invoice B' with an amount of 1 sat on their own node.3. The attacker deserializes invoice B', replaces the payment hash with the payment hash of invoice A, re-signs the invoice, and serializes it again, creating a malicious invoice B.4. The attacker then creates a new account in LNbits and pays invoice B.5. The LNbits backend uses the payment hash from invoice B to determine whether this is an internal payment or a payment via Lightning Network.6. Since the backend assumes that the payment hash commits to the payment details, it finds invoice A in its database.7. The backend settles the payment internally by crediting invoice A and debiting invoice B, effectively "creating" 999 sats for the attacker.To mitigate this exploit, backends should either use unique "checking id's" for internal payment lookups or implement additional checks to ensure that invoice details have not been tampered with (e.g., comparing amounts between invoices).This exploit highlights two important lessons. Firstly, it demonstrates the level of sophistication of attackers familiar with the Lightning Network. This attack requires a deep understanding of bolt-11 and custom tools to create the malicious invoice. Secondly, it emphasizes that the "payment hash" of an invoice is not a true "payment" hash but rather a "preimage" hash. Developers should be cautious about assuming that this hash commits to payment details like amount and pubkey. Moving forward, it is recommended to refer to this field as the "preimage hash."In conclusion, the LNbits team has addressed an exploit that allowed attackers to create fake balances by manipulating invoices. Users are advised to update their systems promptly, and developers should implement appropriate checks to prevent similar attacks in their applications.Best regards,Calle</p>
    <hr>
    <p><i> Updated on: 2023-07-03T03:14:02.125996+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>