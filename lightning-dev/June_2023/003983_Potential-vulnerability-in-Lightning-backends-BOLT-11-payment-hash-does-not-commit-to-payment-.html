<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Last month, the LNbits team discovered an exploit in their system that allowed attackers to create fake balances by manipulating invoices. This exploit has been patched in the latest version of LNbits, and users are advised to update as soon as possible. The team believes that similar exploits may be possible in other Lightning applications, especially those involving custodial wallets, payment processors, and account management software.The specific attack involved inserting the payment hash of one payment into a different payment, creating a malicious invoice that could deceive the backend into treating it as a legitimate payment. Here is how the attack was carried out: 1. The attacker creates invoice A with an amount of 1000 sat in LNbits.2. The attacker also creates invoice B' with an amount of 1 sat on their own node.3. The attacker deserializes invoice B', replaces its payment hash with the payment hash of invoice A, re-signs the invoice, and serializes it again, creating the malicious invoice B.4. The attacker then creates a new account in LNbits and pays invoice B.5. The LNbits backend uses the payment hash of invoice B to determine whether the payment is internal or via Lightning Network.6. Since the backend assumes that the payment hash commits to the payment details, it finds invoice A in its database.7. The backend settles the payment internally by crediting invoice A and debiting invoice B.8. The attacker successfully "creates" 999 sats.To mitigate this vulnerability, backends should use unique "checking id's" for internal payment lookups or implement additional checks to ensure that the invoice details have not been tampered with. For example, verifying that the amounts of the original and received invoices match.There are two important lessons to learn from this incident. Firstly, it highlights the level of sophistication of attackers familiar with Lightning Network technology. This particular attack required a deep understanding of bolt-11 and custom tooling to create the malicious invoice. Secondly, it emphasizes that the "payment hash" of an invoice is not a true "payment" hash but rather a "preimage" hash. Developers should avoid assuming that this hash commits to payment details like amount or pubkey. The term "preimage hash" is suggested as a more accurate description.In conclusion, the LNbits team has addressed a critical exploit in their system and advises users to update promptly. Developers of Lightning applications should also be aware of similar vulnerabilities and take appropriate measures to secure their platforms.</p>
    <hr>
    <p><i> Updated on: 2023-07-06T03:05:25.473904+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>