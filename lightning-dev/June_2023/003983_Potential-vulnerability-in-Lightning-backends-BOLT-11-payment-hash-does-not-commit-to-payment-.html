<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Last month, the LNbits team discovered an exploit in their system that allowed attackers to create fake balances by exploiting a quirk in how invoices are handled. They have released a patch for this issue in version 0.10.5 and encourage users to update as soon as possible. The team believes that similar exploits may exist in other Lightning applications, particularly those involving custodial wallets, payment processors, and account management software.The attack involved inserting a payment hash from one payment into a different payment, creating a malicious invoice that tricks the backend into thinking it is a legitimate payment. Here's how it works: the attacker creates Invoice A with an amount of 1000 sat in LNbits, then creates Invoice B' with an amount of 1 sat on their own node. They then modify B' by replacing its payment hash with the payment hash from A, re-sign the invoice, and serialize it again to create the malicious Invoice B. The attacker then creates a new account in LNbits and pays Invoice B.The LNbits backend uses the payment hash from Invoice B to determine whether the payment is internal or via the Lightning Network. Since they assume that the payment hash commits to the payment details, the backend finds Invoice A in its database. However, it is important to note that payment hashes only commit to the preimage, not the payment details like the amount. As a result, the backend settles the payment internally, crediting Invoice A and debiting Invoice B, effectively "creating" 999 sats for the attacker.To mitigate this issue, backends should use self-generated unique checking IDs for internal payments or implement additional checks to ensure that the invoice details have not been tampered with. For example, verifying that the amounts in Invoice A and Invoice B are the same.This exploit highlights the sophistication of attackers familiar with Lightning Network technology. It requires a deep understanding of bolt-11 and custom tooling to create the malicious invoice. Additionally, it underscores the importance of recognizing that the payment hash in an invoice is not a true payment hash but rather a preimage hash. Referring to it as such can help avoid implicit assumptions about its commitment to payment details like amount and pubkey.In conclusion, LNbits has addressed an exploit that allowed attackers to generate fake balances through manipulating invoices. The team encourages users to update their software and emphasizes the need for vigilance in handling payment hashes and implementing proper checks to prevent similar exploits in other Lightning applications.</p>
    <hr>
    <p><i> Updated on: 2023-07-11T02:42:37.721355+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>