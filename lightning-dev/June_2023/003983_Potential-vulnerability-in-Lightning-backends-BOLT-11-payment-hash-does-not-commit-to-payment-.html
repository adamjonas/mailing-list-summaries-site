<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>In a recent discovery, the LNbits team has uncovered an exploit that allows attackers to manipulate invoices and create fraudulent balances. This exploit takes advantage of a vulnerability in how invoices are handled internally. To address this issue, LNbits has released version 0.10.5 with a patch, and users are urged to update as soon as possible.The attack involves the insertion of a payment hash from one payment into another, resulting in a malicious invoice that tricks the backend into treating it as the original payment. The process starts with the attacker creating two invoices: A and B'. The attacker then replaces the payment hash of B' with that of A, re-signs the invoice, and generates the malicious invoice B. Finally, the attacker creates a new account in LNbits and pays the malicious invoice B.The LNbits backend uses the payment hash to determine whether the payment is internal or via the Lightning Network. Since the payment hash commits to the original payment, the backend mistakenly settles the payment internally by crediting A and debiting B, effectively allowing the attacker to create 999 satoshis out of thin air.To mitigate this exploit, backends should implement additional checks to ensure that invoice details have not been tampered with. Using self-generated unique "checking id's" or verifying the equality of amounts between invoices can help prevent such attacks.This incident highlights two important lessons. Firstly, it demonstrates the level of sophistication exhibited by attackers familiar with Lightning Network technology. Executing this exploit requires a deep understanding of bolt-11 and specialized tools. Secondly, it emphasizes the need to recognize that the "payment hash" of an invoice is actually a "preimage" hash and does not commit to payment details like the amount or public key. Referring to this field as a "preimage hash" can help developers avoid making assumptions about its functionality.Overall, this discovery serves as a warning to developers working on custodial wallets, payment processors, and account management software to be vigilant and address potential vulnerabilities in their applications.</p>
    <hr>
    <p><i> Updated on: 2023-07-10T03:01:17.705635+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>