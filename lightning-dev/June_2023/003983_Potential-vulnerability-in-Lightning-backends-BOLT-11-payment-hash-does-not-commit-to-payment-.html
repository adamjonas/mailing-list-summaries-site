<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>In a recent discovery, the LNbits team has identified an exploit that allows attackers to create fraudulent balances by taking advantage of how invoices are handled internally. This exploit has been patched in LNbits version 0.10.5, and users are strongly advised to update their systems immediately. The team believes that similar exploits may be possible in other Lightning applications, particularly those involved in custodial wallets, payment processors, and account management software.The attack works by manipulating payment hashes within invoices. The attacker creates two invoices: A and B'. By inserting the payment hash from invoice A into invoice B', the attacker can create a malicious invoice B that tricks the backend into treating B as if it were A. The attacker then creates a new account in LNbits and pays invoice B. The LNbits backend, using the payment hash from invoice B, mistakenly recognizes the payment as internal and settles it by crediting the balance of invoice A while debiting the balance of invoice B. As a result, the attacker effectively generates a balance increase of 999 satoshis.To mitigate this exploit, backends should implement certain measures. One approach is to use self-generated unique "checking id's" for internal payment lookups. Additionally, backends can incorporate additional checks to ensure that invoice details have not been tampered with, such as verifying that the amounts of the invoices match.This incident highlights two important lessons. Firstly, it underscores the level of sophistication exhibited by attackers familiar with Lightning Network (LN) technology. This particular exploit requires a deep understanding of bolt-11 and custom tooling to produce the malicious invoice. Secondly, it emphasizes the need to clarify the terminology used within LN applications. The "payment hash" field in invoices is more accurately described as a "preimage" hash since it only commits to the preimage and not to payment details like amount or pubkey. Adopting this terminology can help prevent developers from making incorrect assumptions about the purpose of this field.In conclusion, users of LNbits are urged to update their systems promptly to avoid falling victim to this exploit. Other Lightning applications should also be cautious and consider implementing the recommended mitigation measures to protect against similar attacks.</p>
    <hr>
    <p><i> Updated on: 2023-07-01T03:23:28.077809+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>