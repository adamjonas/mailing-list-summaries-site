<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Dear list,Last month, the LNbits team discovered an exploit that allows attackers to create fraudulent balances by exploiting a vulnerability in how invoices are handled internally. The team has released a patch in version 0.10.5 of LNbits and urges users to update as soon as possible. This email aims to describe the attack in detail, as it is believed that similar exploits could be possible in other Lightning applications.In summary, the attacker is able to manipulate the payment hash of one invoice and insert it into another, creating a malicious invoice that tricks the backend into believing it is a legitimate payment. Here's how the attack works:1. The attacker creates Invoice A for 1000 sat in LNbits.2. The attacker also creates Invoice B' for 1 sat on their own node.3. The attacker deserializes B', inserts payment_hash(A) into payment_hash(B), re-signs the invoice, and serializes it again, producing the malicious Invoice B.4. The attacker then creates a new account in LNbits and pays Invoice B.5. The LNbits backend uses payment_hash(B) to determine if the payment is internal or via the Lightning Network.6. Since payment_hash(A) commits to Invoice A, the backend finds A in its database.7. The backend settles the payment internally by crediting A and debiting B.8. As a result, the attacker "creates" 999 sats out of thin air.To mitigate this exploit, backends should either use self-generated unique "checking id's" for internal payments or implement additional checks to ensure that the invoice details have not been tampered with (e.g., verifying amount(A) == amount(B)).There are two important lessons to learn from this incident. Firstly, it highlights the level of sophistication displayed by LN-savvy attackers, as this attack requires a deep understanding of bolt-11 and custom tooling to produce the malicious invoice. Secondly, it underscores the misconception surrounding the term "payment hash." It is important to note that the payment hash is actually a preimage hash and only commits to the preimage itself, not the payment details such as amount or pubkey. To avoid confusion, it is suggested to refer to this field as the "preimage hash" moving forward.Best regards,Calle</p>
    <hr>
    <p><i> Updated on: 2023-06-29T03:02:33.512665+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>