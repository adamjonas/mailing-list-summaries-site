<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Earlier last month, the LNbits team discovered an exploit that allowed attackers to create fake balances by manipulating invoices. This issue has been patched in the latest version of LNbits (0.10.5), and users are encouraged to update as soon as possible. The team believes that similar exploits may be possible in other Lightning applications, particularly those involved in custodial wallets, payment processors, and account management software.The attack works by inserting the payment hash of one payment (A) into a different payment (B), creating a malicious invoice (B) that tricks the system into believing that B is equal to A. The attacker follows several steps to carry out this exploit, including creating two invoices (A and B'), inserting the payment hash(A) into payment_hash(B), re-signing the invoice, and then creating a new account and paying the malicious invoice (B) in LNbits.The LNbits backend uses the payment_hash(B) to determine whether the payment is internal or via the Lightning Network. However, the critical issue is that payment hashes do not commit to any payment details such as the amount. This allows the attacker to settle the payment internally by crediting A and debiting B, effectively creating 999 satoshis out of thin air.To mitigate this type of exploit, backends should either use self-generated unique "checking ids" for internal payments or implement additional checks to ensure that the invoice details have not been tampered with (e.g., verifying that the amounts match).This incident highlights two important lessons. Firstly, it underscores the sophistication of LN-savvy attackers who possess a deep understanding of bolt-11 and utilize custom tools to create malicious invoices. Secondly, it emphasizes that the "payment hash" in an invoice is actually a "preimage" hash and does not commit to payment details like the amount or pubkey. The author suggests renaming this field as the "preimage hash" to avoid developers mistakenly assuming that it includes payment details.Overall, this incident serves as a reminder for developers and users of Lightning applications to remain vigilant against potential exploits and to implement appropriate security measures to protect against such attacks.</p>
    <hr>
    <p><i> Updated on: 2023-07-05T02:56:28.502774+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>