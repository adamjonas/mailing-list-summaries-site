<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Earlier last month, LNbits discovered an exploit that allowed attackers to create balances by manipulating invoices. The team has released a patch in version 0.10.5 and urges users to update immediately. This exploit may also be possible in other Lightning applications, making it important for those working on custodial wallets, payment processors, and account management software to take note.The attack involved the insertion of a bolt-11 payment hash from one payment into another, creating a malicious invoice that tricks the backend into thinking they are the same. The process begins with the attacker creating invoice A in LNbits with an amount of 1000 sat. Then, they create invoice B' with an amount of 1 sat on their own node. The attacker proceeds to deserialize B', insert payment_hash(A) into payment_hash(B), re-sign the invoice, and serialize it again, resulting in malicious invoice B. Finally, the attacker creates a new account in LNbits and pays invoice B.The LNbits backend uses payment_hash(B) to determine if the payment is internal or via LN. It finds invoice A in its database because it assumes that payment_hash(A) commits to A. However, it is crucial to note that payment hashes do not commit to payment details like the amount, only to the preimage.To mitigate this issue, backends should use self-generated unique "checking id's" for internal payments or implement additional checks to ensure the invoice details have not been tampered with (e.g., comparing amounts).This incident highlights two lessons. Firstly, it emphasizes the sophistication of LN-savvy attackers and their understanding of bolt-11. This attack required custom tooling to produce the malicious invoice. Secondly, it brings attention to the misconception that the "payment hash" of an invoice represents the payment itself when it actually refers to the preimage. Developers are encouraged to refer to this field as the "preimage hash" to avoid misunderstandings.Overall, it is crucial for users of LNbits and other Lightning applications to update their software promptly and implement necessary precautions to prevent similar exploits.</p>
    <hr>
    <p><i> Updated on: 2023-07-08T02:51:28.059577+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>