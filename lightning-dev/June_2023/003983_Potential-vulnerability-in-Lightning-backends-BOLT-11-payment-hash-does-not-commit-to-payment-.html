<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Dear list,Last month, the LNbits team discovered an exploit that allowed attackers to create balances by manipulating invoices. They quickly patched this exploit in LNbits version 0.10.5 and urge users to update their software. The team believes that similar exploits may be possible in other Lightning applications, particularly those involving custodial wallets, payment processors, and account management software.The attack involved inserting a bolt-11 payment hash of payment A into a different payment, creating a malicious invoice B. The attacker would create invoice A with an amount of 1000 sat in LNbits, then create invoice B' with an amount of 1 sat on their own node. They would then manipulate the invoice by deserializing B', inserting payment_hash(A) into payment_hash(B), re-signing the invoice, and serializing it again. This produced the malicious invoice B. The attacker would create a new account in LNbits and pay invoice B.The LNbits backend would use payment_hash(B) to determine if the payment was internal or via LN. Since payment_hash(A) commits to A, the backend would find invoice A in its database. However, the critical part is that payment hashes do not commit to payment details like amount, only to the preimage. Therefore, the backend would settle the payment internally by crediting invoice A and debiting invoice B, effectively allowing the attacker to "create" 999 sats.To mitigate this exploit, backends should either use unique self-generated "checking ids" for internal payments or implement additional checks to ensure invoice details have not been tampered with. For example, they could assert that the amount of invoice A matches the amount of invoice B.There are two important lessons to learn from this exploit. Firstly, LN-savvy attackers can be highly sophisticated, as demonstrated by the custom tooling required to produce the malicious invoice. Secondly, the term "payment hash" is misleading, as it actually refers to a "preimage" hash and does not commit to payment details. The author suggests using the term "preimage hash" instead.Overall, it is crucial for developers to be aware of potential exploits and take necessary precautions when designing Lightning applications.Best,Calle</p>
    <hr>
    <p><i> Updated on: 2023-07-04T03:06:13.811090+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>