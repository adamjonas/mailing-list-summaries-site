<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Dear list,In a recent discovery, the LNbits team found an exploit that allows attackers to create fake balances by manipulating invoices. This issue has been addressed in the latest version of LNbits (0.10.5), and users are strongly advised to update their software as soon as possible. It is important to understand the nature of this attack, as it may be applicable to other Lightning applications, especially those involving custodial wallets, payment processors, and account management software.The attack involves inserting the payment hash of one transaction into another, resulting in a malicious invoice that appears legitimate to the backend system. Here's how it works: 1. The attacker creates an invoice A with an amount of 1000 sat in LNbits.2. The attacker also creates a separate invoice B' with an amount of 1 sat on their own node.3. The attacker then modifies B' by replacing its payment hash with the payment hash of A. This modified invoice is now referred to as B.4. To complete the exploit, the attacker creates a new account in LNbits and pays invoice B.5. The LNbits backend, using the payment hash from invoice B, mistakenly identifies the payment as an internal transfer due to the assumption that the payment hash commits to the original invoice details.6. Consequently, the backend processes the payment by crediting invoice A and debiting invoice B, effectively creating 999 sat out of thin air.To mitigate such attacks, backends should implement additional checks to ensure that invoice details have not been tampered with. One method is to use self-generated unique "checking ids" for internal payment lookups. Alternatively, developers can assert that the amounts of the original and modified invoices remain unchanged.This incident highlights two critical lessons. Firstly, it demonstrates the level of sophistication exhibited by attackers well-versed in Lightning Network technology. This particular exploit required a deep understanding of bolt-11 and custom tools to create the malicious invoice. Secondly, it emphasizes the misconception surrounding the term "payment hash" in invoices. In reality, this field should be referred to as the "preimage hash," as it only serves as a reference to the preimage and does not commit to payment details such as amount or pubkey.Moving forward, it is advisable to adopt this terminology change and recognize the true nature of the "preimage hash" in order to prevent similar attacks in the future.Best,Calle</p>
    <hr>
    <p><i> Updated on: 2023-06-30T03:03:12.094629+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>