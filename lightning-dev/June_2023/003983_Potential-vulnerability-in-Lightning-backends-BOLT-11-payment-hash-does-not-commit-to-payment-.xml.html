<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Potential vulnerability in Lightning backends: BOLT-11 &#34;payment hash&#34; does not commit to payment!</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> callebtc 2023-06-19 15:26:05+00:00
            <br><i>Published on: 2023-06-19T15:26:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.xml.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>The LNbits team has discovered an exploit that enables an attacker to create balances out of thin air by abusing a quirk in how invoices are handled internally. The attack is possible due to the insertion of a bolt-11 payment hash of payment A into a different payment, creating a malicious invoice B that can trick the backend into believing that B == A. The attacker creates invoice A of amount 1000 sat in LNbits, then creates invoice B' of amount 1 sat on their own node. They deserialise B', insert payment_hash(A) into payment_hash(B), re-sign the invoice, and serialise it again, producing malicious invoice B. The attacker then creates a new account in LNbits and pays B. The mitigation for this exploit is simple: backends should either use self-generated unique "checking id's" for looking up internal payments or use additional checks to ensure that the invoice details have not been messed around with (e.g., asserting amount(A) == amount(B)). This attack highlights the level of sophistication of LN-savvy attackers and their fundamental understanding of bolt-11, which requires custom tooling to produce a malicious invoice.The second lesson learned from this attack is that the "payment hash" of an invoice is not a "payment" hash but merely a "preimage" hash â€“ and nothing else. Naming this field as such increases the chance of developers implicitly assuming that the hash commits to payment details like amount, pubkey, etc. The LNbits team encourages developers to refer to this field as simply the "preimage hash."</p>
    <hr>
    <p><i> Updated on: 2023-06-27T04:38:05.978819+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>