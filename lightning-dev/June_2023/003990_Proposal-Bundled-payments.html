<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Proposal: Bundled payments</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> SomberNight 2023-06-20 16:49:05+00:00
            <br><i>Published on: 2023-06-20T16:49:05+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Proposal-Bundled-payments.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003990.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>One important point to stress in the context is that there are potentially three different entities involved in these payments. This may not be obvious at first glance, especially in the example of a submarine swap where people expect just two entities: the user ("customer") and the server ("swap provider"). The proposal requires senders to be aware that the payment will lead to a channel creation or splice on the receiver's end. All existing software used by senders would need to be updated accordingly.In the submarine swap scenario, there are three entities involved: Alice (the user), a swap service provider (server), and Bob (who wants to pay Alice via Lightning). Alice generates an invoice to receive money on-chain, and Bob needs to implement Thomas' proposal (or equivalent) to parse an invoice containing two payment hashes and corresponding amounts. Using a swap service, Bob can pay Alice so that he pays on Lightning and Alice receives on-chain.The process involves Alice generating a preimage and calculating its hash for the actual amount she wants to receive. Alice contacts the swap server with this information. The swap server generates another preimage and its hash for a small prepayment amount. The server then creates a lightning invoice containing both preimages and amounts, which Alice checks and gives to Bob. Bob does not need to know that the nodeid signing the LN invoice does not belong to Alice.Bob sees the invoice contains two payment hashes and amounts and sends HTLCs to cover both. The HTLCs arrive at the swap server, who holds them until it sees HTLCs with enough offered money for both the prepayment and the main payment. The server fulfills the HTLCs for the prepayment and creates a swap funding transaction on-chain. Alice sees the swap funding transaction on-chain, validates it, and broadcasts a claim transaction using the preimage for the main payment. The server fulfills the still pending HTLCs for the main payment using this preimage.It's important to note that Bob is a simple lightning wallet, and all the security checks and swap logic are only implemented on Alice's side. The drawback is that Bob may experience a delay as he pays on Lightning but ends up waiting for on-chain transactions to be mined without knowing or needing to know about it. Instead of a special bolt11 invoice, Alice could create a bip21 URI containing both an on-chain address and the lightning invoice, allowing Bob the choice of paying on-chain or via Lightning.Another clear use case besides swaps is JIT (Just-In-Time) channels. Similar to the swap example, Alice can negotiate with the service provider to have a JIT channel opened to her, and the HTLC forwarded using that channel. Alice can wait for the channel funding to be mined before releasing the preimage for the main payment. Bob is agnostic to what happens between the service provider and Alice and only sees the delay in the fulfillment of the HTLC.The proposal suggests adding a new feature to BOLT-11, where an invoice can contain two bundled payments with distinct preimages and amounts. This is useful for services that require a prepayment of a mining fee for non-custodian exchanges like submarine swaps and JIT channels. The sender would need to support this new feature, and it could be made optional during a transition period. The decision to make the feature required or optional would remain with the service provider.Overall, the proposed extension to BOLT-11 aims to address the need for prepayments in certain Lightning Network use cases and improve interoperability among different implementations.In a recent discussion on the lightning-dev mailing list, ThomasV proposed a solution to address vulnerability to Denial of Service (DoS) attacks faced by Boltz. Currently, Boltz is susceptible to DoS attacks where attackers force them to pay on-chain fees. To protect against this attack, providers like Phoenix need to ask for the preimage of the main payment before opening the channel. However, this makes the service custodian according to European MICA regulation. Competitors who refuse to offer custodian services are excluded from the game.To solve this issue, ThomasV suggests bundling the prepayment and the main payment in the same BOLT-11 invoice. The semantics of bundled payments would involve including two preimages and two amounts in the invoice. The receiver would wait until all the HTLCs (Hash Time Locked Contracts) of both payments have arrived before fulfilling the HTLCs of the pre-payment. If the main payment does not arrive, they should fail the pre-payment with a MPP (Multi-Path Payments) timeout. Once the HTLCs of both payments have arrived, the receiver fulfills the HTLCs of the prepayment and broadcasts their on-chain transaction. It's worth noting that the main payment can still fail if the sender never reveals the preimage of the main payment.ThomasV acknowledges that his proposal does not prevent the service provider from stealing the pre-payment, but states that this is already the</p>
    <hr>
    <p><i> Updated on: 2023-07-08T02:45:57.028263+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>