<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Proposal: Bundled payments</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Thomas Voegtlin 2023-06-13 08:10:29+00:00
            <br><i>Published on: 2023-06-13T08:10:29+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Proposal-Bundled-payments.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003977.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Good morning,I would like to propose an extension to BOLT-11, which would allow invoices to contain two bundled payments with distinct preimages and amounts. This proposal addresses the use case of services that require a prepayment of a mining fee for non-custodian exchanges, such as submarine swaps and JIT channels.In both cases, the service provider receives a HTLC for which they do not have the preimage. To proceed with the exchange, they must send funds on-chain and wait for the client to reveal the preimage when claiming the payment. However, there is no guarantee that the client will actually claim the payment, so service providers often ask for prepayment of mining fees.For services like Loop by Lightning Labs, which use dedicated client software, asking for prepayment is possible. However, competitors like Boltz exchange, which do not require a dedicated wallet, face challenges. Their website shows an invoice to the user, making it impractical to show two invoices simultaneously. This vulnerability exposes Boltz to DoS attacks where attackers force them to pay on-chain fees.JIT channel providers also face a similar issue. To protect themselves against mining fee attacks, they need to ask for the preimage of the main payment before opening the channel. However, this makes them custodians, falling within the scope of European MICA regulation. Competitors who refuse to offer custodian services, like Electrum, are excluded from the game.To address these issues, bundling the prepayment and main payment in the same BOLT-11 invoice would be beneficial. The proposed semantics of bundled payments are as follows: the invoice contains two preimages and two amounts (prepayment and main payment). The receiver should wait until all HTLCs of both payments have arrived before fulfilling the HTLCs of the pre-payment. If the main payment does not arrive, they should fail the pre-payment with a MPP timeout. Once the HTLCs of both payments have arrived, the receiver fulfills the HTLCs of the prepayment and broadcasts their on-chain transaction. However, it is still possible for the main payment to fail if the sender never reveals the preimage.While this proposal does not prevent service providers from stealing the pre-payment, it aims to level the competition between lightning service providers. Currently, Loop requires a dedicated client, leaving competitors without an established user base vulnerable to mining fee attacks. ACINQ would also benefit from this change, as it would allow them to make their pay-to-open service fully non-custodian. The current 'pay-to-open' service used by Phoenix falls within the scope of the European MICA regulation, which could pose issues.It is important to note that this proposed change should be implemented in BOLT-11 rather than using BOLT-12 or onion messages. The proposal does not require the exchange of new messages, making it a non-interactive solution.Cheers,ThomasV</p>
    <hr>
    <p><i> Updated on: 2023-07-10T02:53:33.456611+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>