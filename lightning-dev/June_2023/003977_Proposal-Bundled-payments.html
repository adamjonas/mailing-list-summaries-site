<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
    <title>Atom Feed Display</title>
    <link rel="stylesheet" href="../../archive_styles.css">
</head>

<body BGCOLOR="#fffffb">
    
    <h1>Proposal: Bundled payments</h1>
    <hr class="solid">
    
    <ul>
        
        
            <p><b>Author:</b> Thomas Voegtlin 2023-06-13 08:10:29+00:00
            <br><i>Published on: 2023-06-13T08:10:29+00:00</i></p>

        
        

        
        
        <li>
        <a href="/lightning-dev/June_2023/combined_Proposal-Bundled-payments.html"> Combined Summary of all posts in thread </a>
        </li>
        
        <li>
            
                <a href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003977.html">Click here to read original discussion on the lightning-dev mailing list</a>
            
        </li>

    </ul>

    <hr>
    <h3> Summary:</h3>
    <p>Good morning,ThomasV is proposing an extension to BOLT-11, the Lightning Network invoice format. The proposed extension would allow invoices to contain two bundled payments with distinct preimages and amounts. This extension is aimed at addressing the use case of services that require prepayment of a mining fee for non-custodian exchanges such as submarine swaps and JIT channels.In both cases, service providers receive a Hash Time-Locked Contract (HTLC) for which they do not have the preimage. They need to send funds on-chain and wait for the client to reveal the preimage when claiming the payment. However, there is no guarantee that the client will actually claim the payment, so service providers ask for prepayment of mining fees.Currently, services like Loop by Lightning Labs can handle prepayments because their software supports it. However, competitors like Boltz exchange cannot do this as it would be impractical to show two invoices simultaneously. This vulnerability exposes Boltz to potential Denial-of-Service (DoS) attacks where attackers force them to pay on-chain fees.For JIT channels, providers who want to protect against mining fee attacks ask for the preimage of the main payment before opening the channel. However, this makes them custodians, which has legal implications under European MICA regulation. Competitors like Electrum, who refuse to offer custodian services, are excluded from this game.To address these issues, ThomasV proposes bundling the prepayment and main payment in the same BOLT-11 invoice. The semantics of bundled payments involve including two preimages and two amounts in the invoice. The receiver should wait for the arrival of all HTLCs for both payments before fulfilling the prepayment HTLCs. If the main payment does not arrive, the prepayment should fail with a Multi-Path Payments (MPP) timeout. Once both payments' HTLCs have arrived, the receiver fulfills the prepayment HTLCs and broadcasts the on-chain transaction. It is worth noting that the main payment can still fail if the sender never reveals the preimage.While this proposal does not prevent service providers from stealing the prepayment, ThomasV believes it would level the playing field among lightning service providers. Currently, Loop requires a dedicated client, and competitors without an established user base running such a client are vulnerable to mining fee attacks. Additionally, ACINQ could benefit from this proposal by making their pay-to-open service fully non-custodian, potentially avoiding compliance issues with European MICA regulation.ThomasV suggests implementing this change in BOLT-11 rather than using BOLT-12 or onion messages. The proposed extension does not require the exchange of new messages and can be done in a non-interactive way. Cheers,ThomasV</p>
    <hr>
    <p><i> Updated on: 2023-07-09T02:55:55.342160+00:00 </i></p>
    
    

    <footer>
        <span style="font-family: Arial, Helvetica, sans-serif;">&#10084;&#65039;</span> <a href="https://chaincode.com" target="_blank" rel="noreferrer" style="text-decoration: none; color: inherit;">Chaincode</a>
    </footer>
</body>

</html>